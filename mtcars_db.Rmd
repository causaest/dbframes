---
title: "Create database files from dataframes in R"
subtitle: "Example with `mtcars`"
author: "Alex"
date: "`r format(Sys.time(), '%d %B %Y, %H:%M:%S')`"
output: 
  html_document:
    df_print: paged
    toc: true
    number_sections: false
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
# library(RSQLite)
```

```{r}
head(mtcars)
```

```{r}
#' Add an ID Column to a Data Frame
#' 
#' Adds an `id` column to a data frame, populated with IDs as character 
#' strings ranging from 1 to the number of rows.
#' 
add_id_col <- function(x) {
  x$id = as.character(seq_len(nrow(x))
  return(x)
}
```

```{r}
#' Convert a Vector to Integer Character Label
#'
#' Converts a vector into a factor, and then into a vector of labels ranging 
#' from 1 to the number of factor levels.
#'
as.cif <- function(x) {
  as.character(as.integer(as.factor(x)))
}
```

```{r}
# # Using dplyr:
# x <- mtcars %>%
#   mutate(make = rownames(mtcars),
#          id = as.character(row_number()), # as.character(1:nrow(mtcars))
#          cyl_id = as.cif(cyl),
#          vs_id = as.cif(vs),
#          am_id = as.cif(am),
#          gear_id = as.cif(gear),
#          carb_id = as.cif(carb))
# rownames(x) <- 1:nrow(mtcars)
```

Using base R:

```{r}
# y <- mtcars
# y$make <- rownames(mtcars)
# y <- add_id_col(y)
# y <- within(y, {
#   make = rownames(mtcars)
#   cyl_id = as.cif(cyl)
#   vs_id = as.cif(vs)
#   am_id = as.cif(am)
#   gear_id = as.cif(gear)
#   carb_id = as.cif(carb)
# })
# rownames(y) <- 1:nrow(y)

y <- mtcars |>
  transform(
    make = rownames(mtcars),
    cyl_id = as.cif(cyl),
    vs_id = as.cif(vs),
    am_id = as.cif(am),
    gear_id = as.cif(gear),
    carb_id = as.cif(carb)
  ) |>
  add_id_col() |>
  {\(data) { rownames(data) <- 1:nrow(data); data }}()
```

```{r}
# x_dplyr <- x
# x <- y
```

Create table of cars specifications

```{r}
specs_table <- y %>%
  dplyr::select(id, mpg, disp:qsec)
head(specs_table)
```

```{r}
specs_table <- y[, c("id", "mpg", "disp", "hp", "drat", "wt", "qsec")]
head(specs_table)
```

Table of cyl

```{r}
# Using dplyr
# cyl_table <- x %>%
#   select(cyl, cyl_id) %>%
#   distinct() %>%
#   arrange(cyl) %>%
#   mutate(cyl = as.character(cyl))
# cyl_table

# Using base R
# cyl_table <- x[, c("cyl", "cyl_id")] |> unique()
# cyl_table <- cyl_table[order(cyl_table$cyl_id), ]
# cyl_table$cyl <- as.character(cyl_table$cyl)
# rownames(cyl_table) <- NULL
# cyl_table

# Using base R and |> pipe
cyl_table <- y[, c("cyl", "cyl_id")] |>
  unique() |>
  (\(df) df[order(df$cyl_id), ])() |>
  (\(df) { df$cyl <- as.character(df$cyl); df })() |>
  (\(df) { rownames(df) <- NULL; df })()
cyl_table
```

Table of vs

```{r}
vs_table <- y %>%
  select(vs, vs_id) %>%
  distinct() %>%
  arrange(vs) %>%
  mutate(vs = as.character(vs))
vs_table
```

Table of am

```{r}
am_table <- y %>%
  select(am, am_id) %>%
  distinct() %>%
  arrange(am) %>%
  mutate(am = as.character(am))
am_table
```

Table of gear

```{r}
gear_table <- y %>%
  select(gear, gear_id) %>%
  distinct() %>%
  arrange(gear) %>%
  mutate(gear = as.character(gear))
gear_table
```

Table of carb

```{r}
carb_table <- y %>%
  select(carb, carb_id) %>%
  distinct() %>%
  arrange(carb) %>%
  mutate(carb = as.character(carb))
carb_table
```

Table of cars

```{r}
cars_table <- y %>%
  select(id, make, cyl_id, vs_id, am_id, gear_id, carb_id) %>%
  mutate(id = as.numeric(id)) %>%
  distinct() %>%
  arrange(id) %>%
  mutate(id = as.character(id))
head(cars_table)
```

Rejoin

```{r}
df <- cars_table %>% 
  right_join(., cyl_table, by = "cyl_id") %>% 
  right_join(., vs_table, by = "vs_id") %>% 
  right_join(., am_table, by = "am_id") %>%
  right_join(., gear_table, by = "gear_id") %>% 
  right_join(., carb_table, by = "carb_id") %>% 
  select(c(id, make, cyl, vs, am, gear, carb)) %>% 
  right_join(., specs_table, by = "id") %>%
  as_tibble()
head(df)
```

Reorder columns and fix data types

```{r}
df <- as.data.frame(df)
rownames(df) <- df$make
df <- df %>%
  select(mpg, cyl, disp:qsec, vs:carb) %>%
  mutate(across(.cols = c(cyl, vs, am, gear, carb), .fns = ~ as.numeric(.x)))
head(df)
```

The constructed data frame is identical to the original

```{r}
identical(mtcars, df)
```

A more relaxed equivalence test, ignoring the row order:

```{r}
nrow(setdiff(mtcars, df)) == 0
```

Create database

```{r}
con <- dbConnect(RSQLite::SQLite(), "mtcars.sqlite")
```

```{r}
dbWriteTable(conn = con, name = "caritems", value = cars_table)
dbWriteTable(con, "cyl", cyl_table)
dbWriteTable(con, "vs", vs_table)
dbWriteTable(con, "am", am_table)
dbWriteTable(con, "gear", gear_table)
dbWriteTable(con, "carb", carb_table)
dbWriteTable(con, "techprop", specs_table)
```

```{r}
dbListTables(con)
```

Close the database connection

```{r}
dbDisconnect(con)
```

Cleanup

```{r}
file.remove("mtcars.sqlite")
```
